---
title: ä½¿ç”¨ Docker å°‡ Next.js æ‡‰ç”¨ç¨‹å¼æ”¾ä¸Š Nginx
date: '2022-09-13'
description: ç¤ºç¯„å¦‚ä½•æ’°å¯«ä¸€ä»½ Dockerfile å°‡æœ¬åœ° React æ‡‰ç”¨ç¨‹å¼ build å¥½çš„éœæ…‹æª”æ”¾å…¥ Nginx åŸ·è¡Œ Dockerã€‚
thumbnailUrl: /images/blog/nextjs-in-docker-with-nginx/banner.webp
tags: ['docker']
---

# å‰è¨€

å¦‚æœè¦å°‡é–‹ç™¼å¥½çš„ç¶²ç«™æ”¾ä¸Šç¶²è·¯ä¾›äººé–±è¦½ï¼Œä¸€èˆ¬æœƒä½¿ç”¨ Nginx æˆ– Apache ä½œç‚º web serverã€‚æœ¬æ–‡ç« å°‡ç´€éŒ„å­¸ç¿’æ’°å¯« `Dockerfile` å°‡æœ¬åœ° Next.js æ‡‰ç”¨ç¨‹å¼ build å¥½çš„æ”¾å…¥ Nginx çš„éç¨‹ã€‚

## ä½¿ç”¨ Dockerfile å°‡ Next.js éœæ…‹è³‡æºæ”¾ä¸Š Nginx

ä¸»è¦æµç¨‹æ˜¯ä½¿ç”¨ Next.js æä¾›çš„ `next export` å°‡æ‡‰ç”¨ç¨‹å¼è¼¸å‡ºç‚ºéœæ…‹ HTMLï¼Œ ç„¶å¾Œæ”¾å…¥ Nginx æŒ‡å®šçš„è·¯å¾‘å°±æå®šäº†ã€‚

<aside>
ğŸ’¡ `next export` è¼¸å‡ºçš„ HTML æ˜¯æ ¹æ“š `getStaticProps` å’Œ `getStaticPaths` å°‡ `/page` è·¯å¾‘ä¸‹çš„æ¯å€‹é é¢ç”Ÿæˆä¸€å€‹ HTML æ–‡ä»¶ï¼ˆåŒ…å« dynamic routesï¼‰ã€‚å¦‚æœæ‡‰ç”¨ç¨‹å¼ä¸­æœ‰ä½¿ç”¨åˆ° `fallback: true` æˆ–æ˜¯ `getServerSideProps` çš„ SSR é é¢å°‡ç„¡æ³•ä½¿ç”¨é€™å€‹æ–¹æ³•æ‰“åŒ…ã€‚æ›´å¤šè³‡è¨Šè«‹æŸ¥é–±[å®˜æ–¹æ–‡ä»¶](https://nextjs.org/docs/advanced-features/static-html-export)ã€‚å¦‚æœæƒ³çŸ¥é“å¦‚ä½•æ‰“åŒ… SSR é é¢å¯ä»¥å¾€ä¸‹ç¹¼çºŒé–±è®€ã€‚

</aside>

é¦–å…ˆå…ˆæº–å‚™å¥½ Next.js æ‡‰ç”¨ç¨‹å¼ï¼Œåœ¨æ ¹ç›®éŒ„æ–°å¢ `.dockerignore` æª”æ¡ˆï¼Œé€™æ¨£ä½¿ç”¨ `ADD` æˆ– `COPY` æŒ‡ä»¤æ™‚ï¼Œæœƒè‡ªå‹•æ’é™¤ `.dockerignore` å…§ç¬¦åˆåç¨±çš„æª”æ¡ˆæˆ–è·¯å¾‘ï¼Œè®“ä¸€äº›æ²’å¿…è¦æˆ–æ•æ„Ÿçš„æª”æ¡ˆä¸æœƒåœ¨éƒ¨ç½²éšæ®µè¢«æ‰“åŒ…é€²å»ã€‚å¯«å…¥ä»¥ä¸‹å…§å®¹ï¼š

```docker
.dockerignore
.next/
.git
Dockerfile
node_modules/
README.md
```

### æ’°å¯« Dockerfile

ä¸€æ¨£åœ¨æ ¹ç›®éŒ„æ–°å¢åç‚º `Dockerfile` æª”æ¡ˆï¼Œç¬¬ä¸€å€‹éšæ®µå‰µé€ ä¸€å€‹åç‚º `deps` çš„å·¥ä½œéšæ®µï¼Œé€é Node.js å®‰è£æ‡‰ç”¨ç¨‹å¼æ‰€éœ€è¦çš„ä¾è³´é …ã€‚å¯«å…¥ä»¥ä¸‹å…§å®¹ï¼š

```docker
FROM node:alpine AS deps
RUN apk add --no-cache libc6-compat
WORKDIR /app
COPY package*.json ./
RUN npm ci
```

- `FROM node:alpine AS deps` å‘Šè¨´ Docker ä½¿ç”¨å¾ Node.js å®˜æ–¹æä¾›çš„ Image é–‹å§‹å®‰è£ï¼Œtag æ˜¯è¼•é‡ç‰ˆçš„ alpineï¼Œè®“ Docker å¹«æˆ‘å€‘æå®šæ‰€éœ€çš„å®‰è£ç’°å¢ƒï¼Œç„¶å¾Œé€é `AS deps` å°‡é€™å€‹éšæ®µå‘½åç‚º `desp`ã€‚
- `RUN apk add --no-cache libc6-compat` å› ç‚ºä½¿ç”¨çš„æ˜¯æœ€è¼•é‡çš„ alpine ç‰ˆæœ¬ï¼Œé€™åœ¨å®‰è£æŸäº›å¥—ä»¶çš„æ™‚å€™æœƒé‡åˆ°å•é¡Œï¼ˆå–æ±ºæ–¼å¥—ä»¶çš„ä¾è³´æ·±åº¦ï¼‰ï¼Œå› æ­¤[å®˜æ–¹å»ºè­°](https://github.com/nodejs/docker-node/tree/b4117f9333da4138b03a546ec926ef50a31506c3#nodealpine)å®‰è£ libc6-compat å°‡å¯èƒ½ç¼ºå°‘çš„ä¾è³´é …ç›®è£œä¸Šã€‚
- `WORKDIR /app` è®“ Docker å‰µå»ºä¸€å€‹åç‚º app çš„è³‡æ–™å¤¾ï¼ŒæŒ‡å®šå·¥ä½œç›®éŒ„ç‚º /app ï¼Œæ¥ä¸‹ä¾†æ‰€æœ‰çš„æ­¥é©Ÿéƒ½å°‡åœ¨è©²ç›®éŒ„ä¸­åŸ·è¡Œã€‚
- `COPY package*.json ./` å°‡æœ¬åœ°ç›®éŒ„çš„ package é–‹é ­ .json çµå°¾çš„æª”æ¡ˆè¤‡è£½åˆ° Container å…§ï¼Œé€™é‚Šçš„ç›®çš„æ˜¯è¦è¤‡è£½ package.json åŠ package-lock.json å…©å€‹æª”æ¡ˆã€‚
`RUN npm CI`  å®‰è£ package æ–‡ä»¶å…§çš„ä¾è³´é …ç›®ã€‚åªæœ‰åœ¨ç¬¬ä¸€æ¬¡ build çš„æ™‚å€™æœƒèŠ±æ¯”è¼ƒé•·çš„æ™‚é–“å®‰è£ï¼Œä¹‹å¾Œå†æ¬¡é€²è¡Œ build æ™‚æœƒå•Ÿç”¨ Docker çš„ cache æ©Ÿåˆ¶ï¼Œåˆ©ç”¨å·²ç¶“å­˜åœ¨çš„ç·©å­˜æ¸›å°‘å®‰è£æ™‚é–“ï¼Œé™¤é package æ–‡ä»¶å…§æœ‰ç•°å‹•ã€‚

<aside>
ğŸ’¡ åœ¨ `docker build` æŒ‡ä»¤çš„æœ€å¾ŒåŠ ä¸Š `--no-cache` ä»£è¡¨é€™æ¬¡çš„ build ä¸æœƒç”¢ç”Ÿç·©å­˜ï¼Œé‚£åœ¨æ¯æ¬¡çš„ build éƒ½æœƒé‡æ–°å®‰è£æ‰€éœ€çš„ä¾è³´é …ã€‚

</aside>

ç¾åœ¨æˆ‘å€‘æœ‰äº†æ‰€éœ€çš„ä¾è³´é …ç›®ï¼Œå†ä¾†å°‡æ‡‰ç”¨ç¨‹å¼çš„åŸå§‹ç¢¼æ”¾é€² Image ä»¥ä¾¿æ¥ä¸‹ä¾†é€²è¡Œå»ºæ§‹æ‰€éœ€çš„éœæ…‹æª”æ¡ˆã€‚ç¹¼çºŒå¯«å…¥ä»¥ä¸‹å…§å®¹ï¼š

```docker
FROM node:alpine AS builder
WORKDIR /app
COPY --from=deps /app/node_modules ./node_modules
COPY . .
RUN npm run build && npm run export
```

- `FROM node:alpine AS builder` ä¸€æ¨£å¾ Node.js å®˜æ–¹æä¾›çš„ Image å•Ÿå‹•ä¸€å€‹åç‚º `builder` çš„å·¥ä½œéšæ®µã€‚
- `COPY --from=deps /app/node_modules ./node_modules` å¾ `deps` éšæ®µå°‡ä¾è³´é …ç›®è¤‡è£½åˆ°æœ¬éšæ®µçš„ `./node_modules` è³‡æ–™å¤¾å…§ã€‚é€™è£¡é›–ç„¶åœ¨ä¸åŒçš„å·¥ä½œéšæ®µï¼Œå»å¯ä»¥å¾ Dockerfile å…§æ‰¾åˆ°ç”¨ `as` æŒ‡å®šçš„ `deps` å–å¾—è³‡æ–™ï¼Œæ˜¯ Docker å¤šéšæ®µåŸ·è¡Œçš„é‡è¦æŠ€å·§ã€‚
`COPY . .` å°‡æœ¬åœ°å·¥ä½œç›®éŒ„çš„åŸå§‹ç¢¼å…¨éƒ¨è¤‡è£½é€²å»ã€‚
- `RUN npm run build && npm run export` ç”Ÿæˆéœæ…‹æª”æ¡ˆã€‚å…ˆåŸ·è¡Œ build æŒ‡ä»¤æ˜¯å› ç‚º export éœ€è¦ build ç”¢ç”Ÿå‡ºä¾†çš„æª”æ¡ˆï¼Œæœ€å¾Œæˆ‘å€‘éœ€è¦çš„éœæ…‹æª”æ¡ˆæœƒåœ¨ `/out` è³‡æ–™å¤¾å…§ã€‚

åŸ·è¡Œåˆ°é€™è£¡å·¥ä½œå°±å¿«å®Œæˆäº†ï¼Œæˆ‘å€‘å·²ç¶“ç”Ÿæˆäº†ä¸€åŒ…éœæ…‹æª”æ¡ˆï¼Œæ¥è‘—è¦å°‡å®ƒæ”¾åˆ° Nginx å…§é‹è¡Œï¼Œæ‰€ä»¥è¦ç”Ÿæˆä¸€å€‹æ–°çš„å·¥ä½œéšæ®µå°‡éœæ…‹æª”æ¡ˆæ”¾é€² Nginx å°æ‡‰çš„ç›®éŒ„ä½ç½®ã€‚ç¹¼çºŒå¯«ä¸‹å»ï¼š

```docker
FROM nginx:alpine AS runner
WORKDIR /app
ENV NODE_ENV production
COPY --from=builder /app/out /usr/share/nginx/html
EXPOSE 8080
ENV PORT 8080
```

- `FROM nginx:alpine AS runner` é€™æ¬¡å¾ Nginx å®˜æ–¹æä¾›çš„ Image é–‹å§‹å®‰è£ï¼Œå•Ÿå‹•ä¸€å€‹åç‚º `runner` çš„å·¥ä½œéšæ®µã€‚
- `ENV NODE_ENV production` è¨­å®šç’°å¢ƒè®Šæ•¸ç‚º productionã€‚
- `COPY --from=builder /app/out /usr/share/nginx/html` å°‡ `builder` éšæ®µè¼¸å‡ºçš„éœæ…‹æª”æ¡ˆä½¿ç”¨ `COPY` æ˜¯è¤‡è£½åˆ° Nginx éœæ…‹æª”æ¡ˆæ”¾ç½®çš„è·¯å¾‘å…§ã€‚
- `EXPOSE 8080` æŒ‡å®š port ç‚º 8080ã€‚

åˆ°é€™é‚Š `Dockerfile` å·²ç¶“å¯«å¥½äº†ï¼Œå®Œæˆå°‡ Next.js æ‡‰ç”¨ç¨‹å¼è¼¸å‡ºæˆéœæ…‹æª”æ¡ˆå¾Œè£é€² Nginxï¼Œæ‰“åŒ…æˆ Imageã€‚å®Œæ•´çš„ `Dockerfile` é•·é€™æ¨£ï¼š

```docker
FROM node:alpine AS deps
RUN apk add --no-cache libc6-compat
WORKDIR /app
COPY package*.json ./
RUN npm ci

FROM node:alpine AS builder
WORKDIR /app
COPY --from=deps /app/node_modules ./node_modules
COPY . .
RUN npm run build && npm run export

FROM nginx:alpine AS runner
WORKDIR /app
ENV NODE_ENV production
COPY --from=builder /app/out /usr/share/nginx/html
EXPOSE 8080
ENV PORT 8080
```

æ¥è‘—åœ¨æ§åˆ¶å°è¼¸å…¥ `docker build -t (you_app_name) .` å°±æœƒåŸ·è¡Œå¯«å¥½çš„ `Dockerfile` æ‰“åŒ…å°ˆæ¡ˆï¼Œç”¢ç”Ÿå‡º Imageã€‚

![svgOptimize](/images/blog/nextjs-in-docker-with-nginx/dockerImage.png)

ç”¨é€™ç¨®æ–¹å¼ç”¢å‡ºä¾†çš„ Image åªæœƒåŒ…å« Nginx åŠéœæ…‹è³‡æºçš„å®¹é‡ï¼Œå¾æˆ‘ä½¿ç”¨åŒä¸€å€‹æ‡‰ç”¨ç¨‹å¼æ‰“åŒ…çš„çµæœä¾†çœ‹ï¼Œ`mysite_nextjs` æ˜¯åŸå§‹æ‡‰ç”¨ç¨‹å¼æ‰“åŒ…çš„å¤§å°ï¼Œ`blog` æ˜¯è¼¸å‡ºéœæ…‹è³‡æºåŠ Nginx æ‰“åŒ…çš„å¤§å°ï¼Œå¯çœ‹åˆ°ç›¸å·®ç”šå¤šã€‚å› æ­¤é€éé€™å€‹æ–¹å¼èƒ½è®“æˆ‘å€‘èƒ½åœ¨æœ€çµ‚éƒ¨ç½²æ™‚åƒ…ä¿ç•™æ‰€éœ€è³‡æºã€‚

æˆåŠŸè¼¸å‡º Image å¾Œå†ä¾† run çœ‹çœ‹æœ‰æ²’æœ‰å•é¡Œã€‚åœ¨æ§åˆ¶å°è¼¸å…¥ `docker run -it -dp 8080:80 blog:latest` å•Ÿå‹• Containerï¼Œæ‰“é–‹ç€è¦½å™¨è¼¸å…¥ç¶²å€ [localhost:8080](http://localhost:8080) æŸ¥çœ‹ã€‚å¦‚æœä¸€åˆ‡é †åˆ©ï¼ŒNext.js è¼¸å‡ºçš„éœæ…‹æª”æ¡ˆå°±å¯ä»¥æˆåŠŸåœ¨ Nginx ä¸ŠåŸ·è¡Œäº†ã€‚

<aside>
ğŸ’¡ Nginx é è¨­çš„ port è™Ÿæ˜¯ 80ï¼Œæˆ‘è¨­å®šçš„ port è™Ÿæ˜¯ 8080ï¼Œç”¨ `-dp 8080:80` ä¾†å•Ÿå‹• Containerï¼ˆ-d èƒŒæ™¯åŸ·è¡Œï¼Œ-p æ˜ å°„ port è™Ÿï¼‰å¾Œï¼Œå°±èƒ½åœ¨ [localhost:8080](http://localhost:8080) çœ‹åˆ°çµæœã€‚

</aside>

## ä½¿ç”¨ Docker compose å°‡ Server-Side-Renderingï¼ˆ*SSR*ï¼‰é é¢æ”¾ä¸Š Nginx

ä¸Šé¢ç¤ºç¯„å¦‚ä½•åˆ©ç”¨ Docker å°‡éœæ…‹è³‡æºæ”¾ä¸Š Nginxï¼Œä½†æ˜¯é¸ç”¨ Next.js é–‹ç™¼çš„æ‡‰ç”¨ç¨‹å¼å¤§å¤šæ˜¯ç‚ºäº†å®ƒæä¾›æ–¹ä¾¿çš„ SSR åŠŸèƒ½ï¼Œè€Œæ—¢ç„¶æ˜¯ SSR é é¢å°±éœ€è¦æœ‰ä¸€å€‹ Server è² è²¬å°è©²é é¢çš„ request é‡æ–°æŠ“å–å°æ‡‰çš„è³‡æ–™ï¼Œæ‰èƒ½å»ºç«‹å®Œæ•´çš„ HTML å›å‚³çµ¦ clientã€‚

![SSR é‹ä½œåŸç† â€” åœ–ç‰‡ä¾†æº Â [Krusche Company](https://kruschecompany.com/ssr-or-csr-for-progressive-web-app/)](/images/blog/nextjs-in-docker-with-nginx/serverSideRendering.png)

SSR é‹ä½œåŸç† â€” åœ–ç‰‡ä¾†æº Â [Krusche Company](https://kruschecompany.com/ssr-or-csr-for-progressive-web-app/)

ç‚ºäº†åœ¨ Nginx ä¸Šé‹è¡Œ SSR çš„æ‡‰ç”¨ç¨‹å¼ï¼Œæ–¹æ³•è¦æœ‰æ‰€æ”¹è®Šï¼Œå¿…é ˆè¦å•Ÿç”¨ Node.js ä½œç‚º Server ä¾†æ¸²æŸ“ HTMLï¼Œå†é€éè¨­å®š Nginx ä¸­çš„ `default.conf` ä¾†è™•ç† client requestã€‚é€™ä»£è¡¨æˆ‘å€‘è¦å•Ÿå‹•å…©å€‹ Container è®“å®ƒå€‘é€šè¨Šï¼Œæ­¤æ™‚å°±è¦ç”¨åˆ° docker composeã€‚è€Œé€™æ¨£åšé‚„èƒ½åˆ©ç”¨ Nginx çš„ç·©å­˜æ©Ÿåˆ¶æ¸›è¼• server loadingã€‚

### Nginx è¨­å®šå¿«å–

é¦–å…ˆè¦æŠ“æ‰¾ Nginx çš„è¨­å®šæª” `default.conf` ï¼Œå› ç‚ºæ“ä½œéƒ½æ˜¯åœ¨ Docker ä¸‹é€²è¡Œï¼Œæ‰€ä»¥è¦é€é `cp` å°‡ Container å…§å°‡éœ€è¦çš„æª”æ¡ˆå–å‡ºæ‰èƒ½é€²è¡Œä¿®æ”¹ã€‚æ­¥é©Ÿå¤§æ¦‚æ˜¯é€™æ¨£ï¼š

1. `docker pull nginx`  ä¸‹è¼‰ Nginx å®˜æ–¹æä¾›çš„ Imageã€‚
2. `docker run -it -dp 80:80 nginx` å•Ÿå‹• Containerã€‚å› ç‚º `-d` æ‰€ä»¥æœƒèƒŒæ™¯åŸ·è¡Œä¸”å°å‡ºè©² Container IDï¼Œå°‡å…¶è¤‡è£½ä¸‹ä¾†ã€‚
3. `docker cp (nginx_container_id):/etc/nginx/conf.d/default.conf .` å°‡ Container å…§çš„ `default.conf` æª”æ¡ˆè¤‡è£½åˆ° `.` è·¯å¾‘ã€‚

ç„¶å¾Œåœ¨ Next.js å°ˆæ¡ˆç›®éŒ„åº•ä¸‹æ–°å¢ä¸€å€‹ `/nginx` è³‡æ–™å¤¾ï¼Œå°‡å‰›å‰›è¤‡è£½å‡ºä¾†çš„ `default.conf` æ”¾é€²å»ï¼Œæ¥è‘—é–‹å•Ÿæª”æ¡ˆä¿®æ”¹è£¡é¢çš„å…§å®¹ã€‚

åœ¨æ–‡ä»¶çš„æœ€ä¸Šæ–¹æ–°å¢é€™è¡Œç¨‹å¼ç¢¼ä¾†é…ç½®å¿«å–è¨­å®šï¼š

```shell
proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=MYCACHE:10m inactive=1d use_temp_path=off;
```

- `/var/cache/nginx`Â  æŒ‡å®šå­˜å„²å¿«å–çš„æª”æ¡ˆè¦å­˜æ”¾åœ¨å“ªä¸€å€‹ç›®éŒ„ã€‚
- `levels=1:2`  è¨­ç½®å¿«å–ç›®éŒ„çš„çµæ§‹ç‚ºäºŒç´šç›®éŒ„ï¼Œå› ç‚ºé è¨­å¿«å–æª”æ¡ˆæœƒæ”¾åœ¨åŒä¸€å€‹ç›®éŒ„ä¸‹æ™‚ï¼Œé€™æ¨£æœƒå½±éŸ¿å¿«å–çš„æ•ˆèƒ½ã€‚
- `keys_zone=mycache:10m`  è¨­å®šå„²å­˜å€å¡Šçš„ä¾†å­˜æ”¾å¿«å–çš„ key å­—ä¸²å’Œå¯ä½¿ç”¨çš„è¨˜æ†¶é«”å¤§å°ã€‚é€™è£¡æ˜¯åœ¨**å…±äº«è¨˜æ†¶é«”**ä¸­è¨­å®šä¸€å¡Šåç‚ºã€ŒMYCACHEã€çš„å„²å­˜å€åŸŸï¼Œå¤§å°é™åˆ¶ç‚º 10 MBã€‚1 MB å¯ä»¥å„²å­˜ 8000 å€‹ keyã€‚
- `inactive=1d` æœªè¢«è¨ªå•çš„å¿«å–ä¿ç•™æ™‚é–“ï¼Œæ™‚é–“åˆ°å°±æœƒè¢«åˆªé™¤ã€‚é è¨­ç‚º 10 åˆ†é˜ã€‚
- `use_temp_path=off` é¿å… Nginx å…ˆå°‡å¿«å–æª”æ¡ˆè¤‡è£½åˆ°è‡¨æ™‚çš„å­˜å„²ç©ºé–“ï¼Œè€Œæ˜¯å°‡æª”æ¡ˆç›´æ¥å¯«å…¥å¿«å–ç›®éŒ„ã€‚

ç‚ºäº†é‹è¡Œ SSR ç¶²ç«™ï¼Œé‚„è¦é‹è¡Œ Node.js çš„ Container å†å°‡å®ƒè¨­å®šæˆè«‹æ±‚ä¸Šæ¸¸ï¼ˆupstreamï¼‰ï¼Œä½œç‚ºè®“ Nginx è«‹æ±‚çš„å¾Œç«¯ä¼ºæœå™¨ä»¥å¾—åˆ°éœ€è¦çš„è³‡æºã€‚ç„¶å¾Œå‘Šè¨´ Nginx éœ€è¦å¿«å–çš„æª”æ¡ˆæ˜¯åŸ·è¡Œ `npm run build` æ‰€ç”Ÿæˆåœ¨ `next/static` ç›®éŒ„åº•ä¸‹çš„éœæ…‹æª”æ¡ˆã€‚æ•´ä»½ `default.conf` æ–‡ä»¶çœ‹èµ·ä¾†å¤§æ¦‚åƒé€™æ¨£ï¼š

```docker
proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=MYCACHE:10m inactive=1d use_temp_path=off;

upstream app_upstream {
  server app:8080;
}

server {
    listen       80;
    listen  [::]:80;

    server_name _;
    server_tokens off;

    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_cache_bypass $http_upgrade;

    location /_next/static {
        proxy_cache MYCACHE;
        proxy_pass http://app_upstream;
    }

    location /static {
        proxy_cache MYCACHE;
        proxy_ignore_headers Cache-Control;
        proxy_cache_valid 60m;
        proxy_pass http://app_upstream;
    }

    location / {
        proxy_pass http://app_upstream;
    }
}
```

é€™é‚Šå¤§è‡´ä¸Šåšçš„äº‹æƒ…æ˜¯é€éæ–°å¢ `location` å‘Šè¨´ Nginx å°‡å¿«å–æ”¾åœ¨æˆ‘å€‘å‘½åç‚º `MYCACHE` çš„å„²å­˜å€å¡Šï¼Œè¦å¿«å–çš„ç›®æ¨™æª”æ¡ˆæ˜¯ç”± Next.js ç”¢ç”Ÿçš„æ‰€æœ‰æª”æ¡ˆï¼ˆåŒ…å«éœæ…‹è³‡æºï¼‰ï¼ŒåŒæ™‚è¨­å®šäº† 60 åˆ†é˜çš„å¿«å–æ™‚é–“ã€‚

### Nginx çš„ Dockerfile

ç‚ºäº†è®“ Nginx èˆ‡ Node.js é€é Docker é€£ç·šï¼Œè¦å…ˆç”¢ç”Ÿ Nginx çš„ Imageï¼Œå› æ­¤è¦æ›¿å®ƒå¯« Dockerfileã€‚åœ¨ `/nginx` ç›®éŒ„åº•ä¸‹æ–°å¢ `Dockerfile` å¯«å…¥ä»¥ä¸‹å…§å®¹ï¼š

```docker
FROM nginx:alpine
RUN rm /etc/nginx/conf.d/*
COPY ./default.conf /etc/nginx/conf.d/
EXPOSE 80
```

é€™æ®µç¨‹å¼ç¢¼åšçš„äº‹æƒ…æ˜¯å°‡ Nginx Image å…§ `/etc/nginx/conf.d` ç›®éŒ„ä¸‹çš„æª”æ¡ˆå…¨éƒ¨åˆªé™¤ï¼Œç„¶å¾ŒæŠŠæˆ‘å€‘å‰›å‰›å¯«å¥½çš„ `.default.conf` æ”¾é€²å»ï¼Œé€™æ¨£ Nginx å°±èƒ½åƒåˆ°å¿«å–è¨­å®šã€‚

### ä¿®æ”¹ Next.js çš„ Dockerfile

æ‰“é–‹å…ˆå‰åœ¨æ ¹ç›®éŒ„åº•ä¸‹è¼¸å‡ºéœæ…‹æª”æ¡ˆæ”¾ä¸Š Nginx çš„ `Dockerfile`ï¼Œé€™æ¬¡æ”¹æˆæœ€å¾Œæœƒå•Ÿå‹• Node server çš„ç‰ˆæœ¬ï¼š

```docker
FROM node:alpine AS deps
RUN apk add --no-cache libc6-compat
WORKDIR /app
COPY package*.json ./
RUN npm ci

FROM node:alpine AS builder
WORKDIR /app
COPY --from=deps /app/node_modules ./node_modules
COPY . .
RUN npm run build

FROM node:alpine AS runner
WORKDIR /app
ENV NODE_ENV production
COPY --from=builder /app/public ./public
COPY --from=builder /app/.next/standalone ./
COPY --from=builder /app/.next/static ./.next/static
USER app
EXPOSE 8080
ENV PORT 8080
CMD ["node", "server.js"]
```

åŸºæœ¬ä¸Šèˆ‡å…ˆå‰çš„ç‰ˆæœ¬å¤§åŒå°ç•°ï¼Œåªæ˜¯é€™æ¬¡åœ¨ builder éšæ®µä¸åŸ·è¡Œ `npm run export` è¼¸å‡ºéœæ…‹æª”æ¡ˆåˆ° `/out` çš„è³‡æ–™å¤¾ï¼Œè€Œæ˜¯ç›´æ¥å¾ `/.next` è¤‡è£½åˆ° runner éšæ®µï¼Œä¸” runner éšæ®µæ”¹ç”¨ Node.jsï¼Œä¸¦æŒ‡å®š port è™Ÿç‚º 8080ï¼Œæœ€å¾Œä½¿ç”¨ `CDM` å°‡ server é‹è¡Œèµ·ä¾†ã€‚

### åˆ©ç”¨ docker compose å•Ÿç”¨å¤šå€‹ Container

æœ€å¾Œå°±æ˜¯è¦åŒæ™‚å•Ÿå‹• Nginx èˆ‡ Node.js å…©å€‹ Containerï¼Œé€™è£¡æœ€å¥½ä½¿ç”¨ `docker compose` ä¾†åšå¤šå®¹å™¨çš„ç®¡ç†ã€‚

å›åˆ°å°ˆæ¡ˆçš„æ ¹ç›®éŒ„ä¸­æ–°å¢ä¸€å€‹ `docker-compose.yml`ï¼š

```yaml
version: "3.9"

services:
  app:
    build: ./

  nginx:
    build: ./nginx
    ports:
      - "8080:80"
```

è¨­å®šå¾ˆå–®ç´”åªæ˜¯å•Ÿå‹•å…©å€‹ Containerï¼Œåˆ†åˆ¥å‘½åç‚º `app` åŠ `nginx`ï¼Œä¸æŒ‡å®šå•Ÿå‹•çš„ Imageï¼Œè€Œæ˜¯è®“ `app` å¾æ ¹ç›®éŒ„ buildï¼Œ`nginx` å¾ `/nginx` çš„ç›®éŒ„ buildã€‚

é€™è£¡è¦ç‰¹åˆ¥æ³¨æ„å‘½åã€‚Docker compose æœƒè‡ªå‹•é è¨­ä¸€å€‹ networkï¼Œå°‡ services å•Ÿå‹•çš„å¤šå€‹ Container åŠ é€²å»ï¼Œé”åˆ°å…±äº«ç¶²è·¯çš„æ•ˆæœã€‚æ›å¥è©±èªªï¼Œè©² network ä¸Šçš„ Container å¯ä»¥é€é**èˆ‡ Container Name ç›¸åŒçš„ hostname äº’ç›¸é€£æ¥ï¼ˆreachableï¼‰**ã€‚

Container Name å¯ä»¥éš¨æ„æ›´å‹•ï¼Œä½†æ˜¯åœ¨æˆ‘å€‘çš„ç¯„ä¾‹ä¸­ï¼Œ`nginx/default.conf` æ–‡ä»¶å…§è¨­å®šçš„ upstream åç¨±ç‚º `app`ï¼Œå› æ­¤åœ¨æ’°å¯« YMAL æª”æ¡ˆæ™‚æ‡‰ç”¨ç¨‹å¼çš„ Container Name å°±å¿…é ˆå¯« `app` ï¼ŒNginx æ‰èƒ½é€é Docker compose çš„ network æ‰¾åˆ°æŒ‡å®šçš„ hostname åšé€£ç·šã€‚

æ³¨æ„åªæœ‰ `nginx` æœ‰è¨­å®šå°å¤–é€£ç·šçš„ port è™Ÿç‚º 8080ï¼ŒåŸå› æ˜¯æˆ‘å€‘å¸Œæœ›æ‰€æœ‰è¦è¨ªå• `app` çš„é€£ç·šéƒ½å¿…é ˆé€é `nginx` çš„ä»£ç†æ‰è¡Œï¼Œè€Œ `nginx` æ˜¯åˆ©ç”¨ Docker compose çš„ç¶²è·¯åŠŸèƒ½æ‰¾åˆ° `app`ã€‚

æœ€å¾Œå•Ÿå‹• Containerï¼Œåœ¨å°ˆæ¡ˆæ ¹ç›®éŒ„çš„æ§åˆ¶å°è¼¸å…¥æŒ‡ä»¤ `docker compose up -d` åŸ·è¡Œ build èˆ‡ runã€‚

ç¾åœ¨å¯ä»¥åœ¨ç€è¦½å™¨è¼¸å…¥ `[http://localhost:8080](http://localhost:8080)` ä¸¦æŸ¥çœ‹çµæœï¼ŒSSR é é¢ä¹Ÿèƒ½æ”¾ä¸Š Nginx åŸ·è¡Œäº†ï¼

<aside>
ğŸ’¡ å› ç‚ºæˆ‘å€‘æ²’æœ‰åœ¨ YMAL æª”æ¡ˆä¸­æŒ‡å®š Imageï¼Œæ‰€ä»¥è¦é‡æ–° build ä¸¦åŸ·è¡Œå¯ä»¥ä¸‹é€™å€‹æŒ‡ä»¤ï¼š `docker-compose up --build`

</aside>

## çµèª

é€é Nginx å¿«å–ï¼Œå¯ä»¥å°‡ç¬¬ä¸€æ¬¡è«‹æ±‚çµæœçš„éœæ…‹æ–‡ä»¶ä¿å­˜åœ¨ clientï¼Œæ¯”èµ·æ¯æ¬¡éƒ½è¨ªå• Node.js åšå‡ºä¸€æ¨£çš„å›æ‡‰ï¼Œå¿«å–ä¼ºæœå™¨å¯ä»¥æœƒä»£æ›¿æˆ‘å€‘å›æ‡‰ï¼Œåˆ©ç”¨ Nginx æä¾›æ›´æœ‰æ•ˆåœ°æœå‹™ã€‚

å¦‚æœæƒ³è¦æ¸¬è©¦å¿«å–æ•ˆæœï¼Œä¹Ÿå¯ä»¥æ·»åŠ  `X-Cache-Status` åˆ° `/nginx/default.conf` æª”æ¡ˆä¸­è§€å¯Ÿçµæœï¼Œéƒ½æ²’å•é¡Œçš„è©±ï¼Œæ¥ä¸‹ä¾†å°±èƒ½éƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒä¸Šå›‰ï¼Œåªæ˜¯è¨˜å¾—åˆ°æ™‚å€™è¦åˆªæ‰ `X-Cache-Status` å°±è¡Œäº†ã€‚